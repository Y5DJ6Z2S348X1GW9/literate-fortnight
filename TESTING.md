# 跨设备消息传递系统 - 测试指南

本文档提供了完整的测试指南，用于验证跨设备消息传递系统的所有功能。

## 目录

1. [测试准备](#测试准备)
2. [10.1 测试 Ably 消息收发功能](#101-测试-ably-消息收发功能)
3. [10.2 测试 Pusher 消息收发功能](#102-测试-pusher-消息收发功能)
4. [10.3 测试重连机制](#103-测试重连机制)
5. [10.4 测试通知功能](#104-测试通知功能)
6. [自动化测试工具](#自动化测试工具)

---

## 测试准备

### 环境要求

- 现代浏览器（Chrome, Firefox, Safari, Edge）
- 稳定的网络连接
- 至少两个设备或浏览器窗口用于跨设备测试

### 初始设置

1. 打开应用：在浏览器中打开 `index.html`
2. 首次配置：
   - 输入设备名称（例如："桌面端"）
   - 记录或自定义频道名称
   - 点击"开始使用"

3. 在第二个设备/窗口中：
   - 打开相同的应用
   - 输入不同的设备名称（例如："移动端"）
   - **使用相同的频道名称**（这很重要！）
   - 点击"开始使用"

---

## 10.1 测试 Ably 消息收发功能

### 测试目标
验证使用 Ably 服务时，消息能够在设备间正确发送和接收。

### 前置条件
- 应用已配置并使用 Ably 服务（默认）
- 两个设备/窗口已连接到相同频道
- 连接状态显示"已连接"

### 测试步骤

#### 测试 1: 桌面端到移动端消息发送

1. **在桌面端窗口：**
   - 确认连接状态为"已连接"
   - 在消息输入框中输入："测试消息 - 桌面到移动"
   - 点击"发送"按钮或按 Enter 键

2. **预期结果：**
   - ✅ 桌面端显示发送成功提示
   - ✅ 消息出现在桌面端消息列表中（右侧，蓝色气泡）
   - ✅ 输入框被清空
   - ✅ 消息在 3 秒内出现在移动端消息列表中（左侧，灰色气泡）
   - ✅ 移动端显示桌面通知（如果窗口未聚焦）

3. **验证消息内容：**
   - 消息文本正确
   - 显示发送设备名称："桌面端"
   - 显示时间戳

#### 测试 2: 移动端到桌面端消息发送

1. **在移动端窗口：**
   - 确认连接状态为"已连接"
   - 输入消息："测试消息 - 移动到桌面"
   - 点击"发送"

2. **预期结果：**
   - ✅ 移动端显示发送成功提示
   - ✅ 消息出现在移动端消息列表中
   - ✅ 消息在 3 秒内出现在桌面端消息列表中
   - ✅ 桌面端显示通知（如果窗口未聚焦）

#### 测试 3: 消息显示和存储

1. **发送多条消息：**
   - 从两个设备交替发送 5-10 条消息
   - 包含不同长度的文本（短消息、长消息）

2. **验证显示：**
   - ✅ 所有消息按时间顺序显示
   - ✅ 发送的消息在右侧（蓝色）
   - ✅ 接收的消息在左侧（灰色）
   - ✅ 每条消息显示设备名称和时间戳
   - ✅ 消息列表自动滚动到最新消息

3. **验证存储：**
   - 刷新页面（F5）
   - ✅ 历史消息仍然显示
   - ✅ 消息顺序保持不变
   - ✅ 最多显示 100 条消息

4. **检查 LocalStorage：**
   ```javascript
   // 在浏览器控制台执行
   const messages = JSON.parse(localStorage.getItem('messaging_app_messages'));
   console.log('存储的消息数量:', messages.length);
   console.log('最新消息:', messages[messages.length - 1]);
   ```

#### 测试 4: 错误处理

1. **空消息测试：**
   - 尝试发送空消息（只有空格）
   - ✅ 应该无法发送
   - ✅ 不显示错误提示（静默处理）

2. **连接断开时发送：**
   - 断开网络连接（DevTools > Network > Offline）
   - 尝试发送消息
   - ✅ 显示"消息发送失败"错误提示
   - ✅ 消息内容保留在输入框中
   - 恢复网络连接
   - ✅ 可以重新发送保留的消息

### 自动化测试

在浏览器控制台运行：
```javascript
await testAblyMessaging();
```

---

## 10.2 测试 Pusher 消息收发功能

### 测试目标
验证服务切换功能和 Pusher 服务的消息收发能力。

### 前置条件
- 应用当前使用 Ably 服务
- 两个设备/窗口已打开

### 测试步骤

#### 测试 1: 切换到 Pusher 服务

1. **在桌面端窗口：**
   - 点击右上角的设置按钮（⚙️）
   - 在"消息服务"下拉菜单中选择"Pusher"
   - 点击"保存"

2. **预期结果：**
   - ✅ 显示"设置已保存"成功提示
   - ✅ 显示"已切换到 PUSHER"提示
   - ✅ 连接状态短暂显示"连接中..."
   - ✅ 几秒后状态变为"已连接"
   - ✅ 设置面板自动关闭

3. **在移动端窗口重复相同步骤**

#### 测试 2: Pusher 消息收发

1. **发送测试消息：**
   - 从桌面端发送："Pusher 测试 - 桌面到移动"
   - 从移动端发送："Pusher 测试 - 移动到桌面"

2. **预期结果：**
   - ✅ 消息成功发送和接收
   - ✅ 消息在 3 秒内到达对方设备
   - ✅ 显示正确的发送确认
   - ✅ 通知功能正常工作

#### 测试 3: 验证服务切换正常工作

1. **检查配置：**
   ```javascript
   // 在浏览器控制台执行
   const config = JSON.parse(localStorage.getItem('messaging_app_config'));
   console.log('当前服务:', config.brokerType); // 应该是 'pusher'
   ```

2. **切换回 Ably：**
   - 打开设置
   - 选择"Ably"
   - 保存
   - ✅ 成功切换并重新连接

3. **发送消息验证：**
   - 发送一条消息
   - ✅ 消息正常收发

### 自动化测试

在浏览器控制台运行：
```javascript
await testPusherMessaging();
```

---

## 10.3 测试重连机制

### 测试目标
验证网络断开时的自动重连功能和连接状态显示。

### 前置条件
- 应用已连接（Ably 或 Pusher）
- 打开浏览器开发者工具

### 测试步骤

#### 测试 1: 模拟网络断开

1. **准备：**
   - 确认当前连接状态为"已连接"
   - 打开 DevTools（F12）
   - 切换到 Network 标签

2. **断开网络：**
   - 在 Network 标签中，将 Throttling 设置为"Offline"
   - 或者关闭 Wi-Fi/断开网络连接

3. **预期结果：**
   - ✅ 5-10 秒内，连接状态变为"未连接"
   - ✅ 状态指示器变为红色或灰色
   - ✅ 控制台显示连接断开日志

#### 测试 2: 验证自动重连

1. **恢复网络：**
   - 将 Throttling 设置回"Online"
   - 或者重新连接网络

2. **预期结果：**
   - ✅ 5 秒内开始尝试重连
   - ✅ 连接状态显示"连接中..."
   - ✅ 成功重连后状态变为"已连接"
   - ✅ 显示"已重新连接"提示消息
   - ✅ 可以正常发送和接收消息

#### 测试 3: 多次断开重连

1. **重复测试：**
   - 重复断开和恢复网络 3-5 次
   - 每次断开等待 10-15 秒

2. **预期结果：**
   - ✅ 每次都能成功重连
   - ✅ 连接状态显示准确
   - ✅ 重连后消息功能正常

#### 测试 4: 连接状态显示

1. **验证状态指示器：**
   - 未连接：红色/灰色，显示"未连接"
   - 连接中：黄色，显示"连接中..."
   - 已连接：绿色，显示"已连接"
   - 连接失败：红色，显示"连接失败"

2. **检查控制台日志：**
   ```javascript
   // 应该看到类似的日志
   // "Connection status changed: disconnected"
   // "Attempting to reconnect..."
   // "Connection status changed: connected"
   ```

### 自动化测试

在浏览器控制台运行：
```javascript
await testReconnection();
// 然后手动执行网络断开/恢复操作
```

---

## 10.4 测试通知功能

### 测试目标
验证桌面通知和移动端推送通知功能。

### 前置条件
- 应用已连接
- 两个设备/窗口已打开

### 测试步骤

#### 测试 1: 桌面通知权限

1. **首次访问：**
   - 清除浏览器数据或使用隐身模式
   - 打开应用并完成配置
   - ✅ 应该自动请求通知权限

2. **授予权限：**
   - 点击"允许"
   - ✅ 权限状态变为"granted"

3. **验证权限：**
   ```javascript
   // 在浏览器控制台执行
   console.log('通知权限:', Notification.permission);
   // 应该显示 "granted"
   ```

#### 测试 2: 桌面通知显示

1. **准备：**
   - 确保两个窗口都已连接
   - 将接收端窗口最小化或切换到其他标签

2. **发送消息：**
   - 在发送端窗口发送消息："测试通知"

3. **预期结果（接收端）：**
   - ✅ 显示桌面通知
   - ✅ 通知标题："新消息"
   - ✅ 通知内容："{设备名称}: 测试通知"
   - ✅ 通知显示应用图标
   - ✅ 5 秒后通知自动关闭

4. **点击通知：**
   - 点击通知
   - ✅ 应用窗口获得焦点
   - ✅ 通知关闭

#### 测试 3: 通知不重复

1. **窗口已聚焦时：**
   - 确保接收端窗口处于活动状态
   - 发送消息

2. **预期结果：**
   - ✅ 消息正常显示在列表中
   - ✅ 不显示桌面通知（因为窗口已聚焦）

#### 测试 4: 移动端推送通知

1. **在移动设备上：**
   - 使用手机浏览器打开应用
   - 完成配置并授予通知权限
   - 将应用添加到主屏幕（PWA）

2. **测试推送：**
   - 从桌面端发送消息
   - 将手机锁屏或切换到其他应用

3. **预期结果：**
   - ✅ 收到推送通知
   - ✅ 通知显示消息内容
   - ✅ 点击通知打开应用

#### 测试 5: Service Worker 注册

1. **检查 Service Worker：**
   ```javascript
   // 在浏览器控制台执行
   navigator.serviceWorker.getRegistration().then(reg => {
       console.log('Service Worker 状态:', reg ? 'Active' : 'Not registered');
       if (reg) {
           console.log('Service Worker 脚本:', reg.active.scriptURL);
       }
   });
   ```

2. **预期结果：**
   - ✅ Service Worker 已注册
   - ✅ 状态为 "Active"

3. **在 DevTools 中验证：**
   - 打开 Application 标签
   - 选择 Service Workers
   - ✅ 看到 service-worker.js 已激活

### 自动化测试

在浏览器控制台运行：
```javascript
await testNotifications();
```

---

## 自动化测试工具

### 加载测试工具

在 `index.html` 中添加测试工具脚本（仅用于测试）：

```html
<!-- 在 </body> 之前添加 -->
<script src="js/test-utils.js"></script>
```

或者在浏览器控制台中动态加载：

```javascript
const script = document.createElement('script');
script.src = 'js/test-utils.js';
document.body.appendChild(script);
```

### 可用的测试命令

```javascript
// 测试 Ably 消息功能
await testAblyMessaging();

// 测试 Pusher 消息功能
await testPusherMessaging();

// 测试重连机制
await testReconnection();

// 测试通知功能
await testNotifications();

// 运行所有测试
await runAllTests();
```

### 测试输出示例

```
🧪 Testing Ably Message Functionality...

✅ PASS: UI Elements Exist All required UI elements are present
✅ PASS: Ably Connection Status Status: 已连接
✅ PASS: Message History Loaded 5 messages in history
✅ PASS: Message Sent and Displayed Message count increased from 5 to 6
✅ PASS: Input Field Cleared After Send Input field should be empty after successful send
✅ PASS: Message Saved to Storage Last stored message: Test message at 10:30:15
✅ PASS: Message Has Required Fields Message structure: id, content, deviceName, timestamp, direction

==================================================
TEST SUMMARY
==================================================
Total Tests: 7
Passed: 7
Failed: 0
Success Rate: 100.00%
==================================================
```

---

## 测试检查清单

### 10.1 Ably 消息收发 ✓

- [ ] 桌面端到移动端消息发送成功
- [ ] 移动端到桌面端消息发送成功
- [ ] 消息在 3 秒内到达
- [ ] 消息正确显示（内容、设备名、时间戳）
- [ ] 消息正确存储到 LocalStorage
- [ ] 历史消息加载正确
- [ ] 发送成功显示确认提示
- [ ] 发送失败显示错误提示并保留内容

### 10.2 Pusher 消息收发 ✓

- [ ] 成功切换到 Pusher 服务
- [ ] 切换后显示确认提示
- [ ] Pusher 连接成功
- [ ] Pusher 消息收发正常
- [ ] 可以切换回 Ably
- [ ] 服务切换不影响消息历史

### 10.3 重连机制 ✓

- [ ] 网络断开时状态变为"未连接"
- [ ] 自动尝试重连（每 5 秒）
- [ ] 重连成功后状态变为"已连接"
- [ ] 显示重连成功提示
- [ ] 重连后消息功能正常
- [ ] 连接状态指示器颜色正确

### 10.4 通知功能 ✓

- [ ] 自动请求通知权限
- [ ] 接收消息时显示桌面通知
- [ ] 通知内容正确（标题、消息、图标）
- [ ] 点击通知聚焦应用窗口
- [ ] 窗口聚焦时不显示通知
- [ ] Service Worker 正确注册
- [ ] 移动端推送通知工作正常

---

## 性能优化建议

基于测试结果，以下是一些优化建议：

1. **消息加载优化**
   - 当前一次性加载所有历史消息
   - 建议：实现虚拟滚动或分页加载

2. **连接状态优化**
   - 重连间隔固定为 5 秒
   - 建议：实现指数退避策略

3. **存储优化**
   - 当前使用 LocalStorage 同步操作
   - 建议：考虑使用 IndexedDB 处理大量消息

4. **通知优化**
   - 每条消息都触发通知
   - 建议：实现通知合并或静音模式

---

## 故障排除

### 问题：无法连接到 Ably/Pusher

**解决方案：**
- 检查网络连接
- 验证 API 密钥是否正确
- 检查浏览器控制台错误日志
- 尝试刷新页面

### 问题：消息发送失败

**解决方案：**
- 确认连接状态为"已连接"
- 检查频道名称是否一致
- 验证消息内容不为空
- 查看控制台错误信息

### 问题：通知不显示

**解决方案：**
- 检查通知权限状态
- 确认浏览器支持通知 API
- 验证窗口未聚焦
- 检查系统通知设置

### 问题：历史消息丢失

**解决方案：**
- 检查 LocalStorage 是否被清除
- 验证存储配额未超限
- 确认浏览器未处于隐身模式

---

## 测试完成标准

所有测试通过的标准：

1. ✅ Ably 消息收发功能完全正常
2. ✅ Pusher 消息收发功能完全正常
3. ✅ 服务切换功能正常工作
4. ✅ 自动重连机制可靠
5. ✅ 连接状态显示准确
6. ✅ 桌面通知功能正常
7. ✅ 移动端推送通知正常
8. ✅ 消息存储和加载正确
9. ✅ 错误处理机制完善
10. ✅ 用户界面响应流畅

---

## 附录：测试数据

### 测试消息示例

```javascript
// 短消息
"Hello"
"测试"
"👍"

// 中等长度消息
"这是一条测试消息，用于验证消息显示功能。"

// 长消息
"这是一条很长的测试消息，用于验证长文本的显示和换行效果。这条消息包含了足够多的文字，可以测试消息气泡的自动换行和最大宽度限制。"

// 特殊字符
"<script>alert('test')</script>"
"Hello\nWorld"
"测试 emoji: 😀 🎉 ❤️"
```

### 测试配置

```javascript
// 设备名称示例
"我的电脑"
"iPhone 13"
"工作笔记本"
"测试设备 1"

// 频道名称示例
"channel-12345678-1234-4123-8123-123456789012"
"my-private-channel"
"test-channel-001"
```

---

**测试完成日期：** _____________

**测试人员：** _____________

**测试结果：** ☐ 通过 ☐ 失败

**备注：** _____________________________________________
