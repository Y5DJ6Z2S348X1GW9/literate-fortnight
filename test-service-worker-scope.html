<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Scope æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #357ABD; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>ğŸ”§ Service Worker Scope ä¿®å¤æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºéªŒè¯ Service Worker scope è·¯å¾„ä¿®å¤æ˜¯å¦æˆåŠŸ</p>
    </div>

    <div class="test-card">
        <h2>æ£€æµ‹ä¿¡æ¯</h2>
        <div id="detection-info"></div>
    </div>

    <div class="test-card">
        <h2>Service Worker æ³¨å†Œæµ‹è¯•</h2>
        <button onclick="testServiceWorker()">æµ‹è¯• Service Worker æ³¨å†Œ</button>
        <div id="sw-result"></div>
    </div>

    <div class="test-card">
        <h2>å·²æ³¨å†Œçš„ Service Workers</h2>
        <button onclick="listServiceWorkers()">æŸ¥çœ‹å·²æ³¨å†Œçš„ Service Workers</button>
        <div id="sw-list"></div>
    </div>

    <script type="module">
        import { pathConfig } from './js/config/PathConfig.js';

        // æ˜¾ç¤ºæ£€æµ‹ä¿¡æ¯
        const detectionInfo = document.getElementById('detection-info');
        const config = pathConfig.getConfig();
        
        detectionInfo.innerHTML = `
            <div class="status info">
                <strong>Base Path:</strong> "${config.basePath || '(root)'}"<br>
                <strong>æ£€æµ‹æ–¹æ³•:</strong> ${config.detectionMethod}<br>
                <strong>è‡ªåŠ¨æ£€æµ‹:</strong> ${config.isAutoDetected ? 'æ˜¯' : 'å¦'}<br>
                <strong>è·¯å¾„æœ‰æ•ˆ:</strong> ${config.isValid ? 'âœ… æ˜¯' : 'âŒ å¦'}
            </div>
            <pre>å®Œæ•´é…ç½®: ${JSON.stringify(config, null, 2)}</pre>
        `;

        // æµ‹è¯• Service Worker æ³¨å†Œ
        window.testServiceWorker = async function() {
            const resultDiv = document.getElementById('sw-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•...</div>';

            try {
                const swPath = pathConfig.resolvePath('service-worker.js');
                let swScope = pathConfig.getBasePath();
                
                // ç¡®ä¿ scope æœ‰å°¾éƒ¨æ–œæ 
                if (!swScope || swScope === '') {
                    swScope = '/';
                } else {
                    swScope = swScope.endsWith('/') ? swScope : swScope + '/';
                }

                resultDiv.innerHTML = `
                    <div class="status info">
                        <strong>Service Worker è·¯å¾„:</strong> ${swPath}<br>
                        <strong>Scope:</strong> ${swScope}<br>
                        <strong>Scope æ ¼å¼:</strong> ${swScope.endsWith('/') ? 'âœ… æ­£ç¡® (æœ‰å°¾éƒ¨æ–œæ )' : 'âŒ é”™è¯¯ (ç¼ºå°‘å°¾éƒ¨æ–œæ )'}
                    </div>
                `;

                const registration = await navigator.serviceWorker.register(swPath, {
                    scope: swScope
                });

                resultDiv.innerHTML += `
                    <div class="status success">
                        <strong>âœ… Service Worker æ³¨å†ŒæˆåŠŸ!</strong><br>
                        <strong>Scope:</strong> ${registration.scope}<br>
                        <strong>Active:</strong> ${registration.active ? 'æ˜¯' : 'å¦'}<br>
                        <strong>Installing:</strong> ${registration.installing ? 'æ˜¯' : 'å¦'}<br>
                        <strong>Waiting:</strong> ${registration.waiting ? 'æ˜¯' : 'å¦'}
                    </div>
                `;

                // ç­‰å¾… Service Worker å°±ç»ª
                await navigator.serviceWorker.ready;
                resultDiv.innerHTML += '<div class="status success">âœ… Service Worker å·²å°±ç»ª</div>';

            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="status error">
                        <strong>âŒ Service Worker æ³¨å†Œå¤±è´¥</strong><br>
                        <strong>é”™è¯¯:</strong> ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };

        // åˆ—å‡ºå·²æ³¨å†Œçš„ Service Workers
        window.listServiceWorkers = async function() {
            const listDiv = document.getElementById('sw-list');
            listDiv.innerHTML = '<div class="status info">æ­£åœ¨æŸ¥è¯¢...</div>';

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                if (registrations.length === 0) {
                    listDiv.innerHTML = '<div class="status info">æ²¡æœ‰å·²æ³¨å†Œçš„ Service Workers</div>';
                    return;
                }

                let html = '<div class="status success">';
                html += `<strong>æ‰¾åˆ° ${registrations.length} ä¸ªå·²æ³¨å†Œçš„ Service Workers:</strong><br><br>`;
                
                registrations.forEach((reg, index) => {
                    html += `
                        <strong>Service Worker #${index + 1}:</strong><br>
                        - Scope: ${reg.scope}<br>
                        - Active: ${reg.active ? 'æ˜¯' : 'å¦'}<br>
                        - Installing: ${reg.installing ? 'æ˜¯' : 'å¦'}<br>
                        - Waiting: ${reg.waiting ? 'æ˜¯' : 'å¦'}<br>
                        <button onclick="unregisterSW('${reg.scope}')">æ³¨é”€æ­¤ Service Worker</button>
                        <br><br>
                    `;
                });
                
                html += '</div>';
                listDiv.innerHTML = html;

            } catch (error) {
                listDiv.innerHTML = `
                    <div class="status error">
                        <strong>âŒ æŸ¥è¯¢å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        };

        // æ³¨é”€ Service Worker
        window.unregisterSW = async function(scope) {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                const reg = registrations.find(r => r.scope === scope);
                
                if (reg) {
                    await reg.unregister();
                    alert('âœ… Service Worker å·²æ³¨é”€');
                    window.listServiceWorkers();
                }
            } catch (error) {
                alert('âŒ æ³¨é”€å¤±è´¥: ' + error.message);
            }
        };

        // è‡ªåŠ¨è¿è¡Œæ£€æµ‹
        console.log('PathConfig é…ç½®:', pathConfig.getConfig());
    </script>
</body>
</html>
